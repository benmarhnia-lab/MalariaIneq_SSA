[
["index.html", "Malaria inequality Chapter 1 Preamble", " Malaria inequality Gabriel Carrasco-Escobar 2020-10-26 Chapter 1 Preamble "],
["data.html", "Chapter 2 Data 2.1 DHS Data 2.2 GPS Data 2.3 ADM Data 2.4 Assemble", " Chapter 2 Data #save.image(&quot;~/mal_ineq/_dat/mal_ineq_dat4.RData&quot;) load(&quot;./_dat/mal_ineq_dat4.RData&quot;) 2.1 DHS Data rm(list = ls()) library(purrr) library(tidyverse) library(haven) library(janitor) library(labelled) library(magrittr) files &lt;- dir(path = &quot;./_dat/DHS/&quot;, pattern = &quot;*.DTA&quot; , recursive = T, full.names = T) dat &lt;- data_frame(filename = files) %&gt;% mutate(country = str_sub(filename, -12,-11), type = str_sub(filename, -10,-9), file_contents = map(.x = filename, .f = ~read_stata(.))) %&gt;% filter(type==&quot;PR&quot;) # Function ======== info &lt;- function(dat) { a &lt;- tibble(var_names = colnames(dat), var_lab1 = var_label(dat, unlist = T), var_lab = as.character(var_lab1), var_lab_make = make_clean_names(var_lab)) %&gt;% dplyr::select(-var_lab1) return(a) } # Function ======== # Variables summary/matches d0 &lt;- dat %&gt;% mutate(codebook = map(.x = file_contents, .f = ~info(.x))) %&gt;% dplyr::select(country, codebook) %&gt;% unnest(cols = c(codebook)) d1 &lt;- d0 %&gt;% group_by(var_lab_make) %&gt;% count() vars &lt;- c(&quot;region&quot;,&quot;province&quot;,&quot;result_of_malaria_measurement&quot;, &quot;wealth_index_factor_score_5_decimals&quot;, &quot;wealth_index_factor_score_combined_5_decimals&quot;, &quot;mothers_highest_educational_level&quot;, &quot;primary_sampling_unit&quot;, &quot;ultimate_area_unit&quot;, &quot;household_sample_weight_6_decimals&quot;, &quot;sample_weight&quot;, &quot;result_of_malaria_rapid_test&quot;, &quot;result_of_malaria_rapid_test_2&quot;, &quot;result_of_rapid_test_of_malaria&quot;, &quot;year_of_interview&quot;, &quot;cluster_number&quot;) # Selected variables dat_s &lt;- dat %&gt;% mutate(subset0 = map(.x = file_contents, .f = ~set_colnames(.x, var_label(.) %&gt;% data_frame() %&gt;% unlist()) %&gt;% clean_names() %&gt;% dplyr::select(any_of(vars)) %&gt;% set_colnames(var_label(.) %&gt;% data_frame() %&gt;% unlist()) %&gt;% clean_names()), subset = map(.x = subset0, .f = ~mutate_all(.x, as_factor) %&gt;% mutate_all(as.character)) ) dat_s_flat &lt;- dat_s %&gt;% #mutate(export = map(.x = subset, .f = ~mutate_all(.x, as.character))) %&gt;% #dplyr::select(subset) %&gt;% dplyr::select(country, subset) %&gt;% unnest() # epiDisplay::tab1(dat_s_flat$result_of_malaria_measurement) # epiDisplay::tab1(dat_s_flat$result_of_malaria_rapid_test) # hist(dat_s_flat$wealth_index_factor_score_5_decimals) # &quot;primary_sampling_unit&quot;, &quot;ultimate_area_unit&quot; iguales a &quot;cluster_number&quot; write.csv(dat_s_flat, &quot;./_dat/dat_s_flat.csv&quot;, na=&quot;&quot;, row.names = F) 2.2 GPS Data #save.image(&quot;~/mal_ineq/_dat/mal_ineq_dat3_gps.RData&quot;) load(&quot;./_dat/mal_ineq_dat3_gps.RData&quot;) library(sf) files_gps &lt;- dir(path = &quot;./_dat/GPS/&quot;, pattern = &quot;*.shp&quot; , recursive = T, full.names = T) %&gt;% data.frame() %&gt;% set_colnames(&quot;filename&quot;) %&gt;% anti_join(dir(path = &quot;./_dat/GPS/&quot;, pattern = &quot;*.xml&quot; , recursive = T, full.names = T) %&gt;% data.frame() %&gt;% set_colnames(&quot;filename&quot;), by = &quot;filename&quot;) dat_gps &lt;- files_gps %&gt;% mutate(country = str_sub(filename, -12,-11), type = str_sub(filename, -10,-9), file_contents = map(.x = filename, .f = ~sf::st_read(.) %&gt;% st_set_geometry(NULL))) dat_gps_flat &lt;- dat_gps %&gt;% unnest() %&gt;% arrange(-DHSYEAR) %&gt;% ungroup() %&gt;% distinct(country, DHSID, .keep_all = T) 2.3 ADM Data AO &lt;- st_read(&quot;./_dat/SHP/AO/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) BU &lt;- st_read(&quot;./_dat/SHP/BU/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% mutate(ISO = &quot;BU&quot;) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) LB &lt;- st_read(&quot;./_dat/SHP/LB/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% mutate(ISO = &quot;LB&quot;) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) MD &lt;- st_read(&quot;./_dat/SHP/MD/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% mutate(ISO = &quot;MD&quot;) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) TG &lt;- st_read(&quot;./_dat/SHP/TG/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) TZ &lt;- st_read(&quot;./_dat/SHP/TZ/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) UG &lt;- st_read(&quot;./_dat/SHP/UG2/shps/sdr_subnational_boundaries.shp&quot;) %&gt;% select(ISO, REGNAME) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) subnat &lt;- st_read(&quot;./_dat/SHP/sdr_subnational_data_2020-09-27/shps/sdr_subnational_data.shp&quot;) %&gt;% filter(ISO %in% c(&quot;BF&quot;,&quot;KE&quot;,&quot;MW&quot;,&quot;ML&quot;,&quot;MZ&quot;,&quot;SL&quot;)) %&gt;% select(ISO, REGNAME) %&gt;% st_cast(&quot;MULTIPOLYGON&quot;) spat &lt;- rbind(subnat,AO) %&gt;% rbind(BU) %&gt;% rbind(LB) %&gt;% rbind(MD) %&gt;% rbind(TG) %&gt;% rbind(TZ) %&gt;% rbind(UG) %&gt;% rename(country = ISO) %&gt;% mutate(REGNAME = toupper(REGNAME), REGNAME = str_replace_all(REGNAME, pattern = &quot;-&quot;, replacement = &quot; &quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;REGION&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;PROVINCE&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;AREA&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;NORTHEASTERN&quot;, replacement = &quot;NORTH EASTERN&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;NORTHERN&quot;, replacement = &quot;NORTH&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;SOUTHERN&quot;, replacement = &quot;SOUTH&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;GREATER&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot; DE &quot;, replacement = &quot; DU &quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;KARUZI&quot;, replacement = &quot;KARUSI&quot;), REGNAME = str_trim(REGNAME, side = &quot;both&quot;), poly = 1) st_write(spat, &quot;./_dat/SHP/union/DHS_adm.shp&quot;) #rm(AO,BU,LB,MD,TG,TZ,UG,subnat,spat,p,p2) 2.4 Assemble dhs_export &lt;- dat_s_flat %&gt;% dplyr::select(-c(primary_sampling_unit,ultimate_area_unit)) %&gt;% mutate(w = ifelse(is.na(household_sample_weight_6_decimals), sample_weight, household_sample_weight_6_decimals), REGNAME = ifelse(country==&quot;BU&quot; | country==&quot;MZ&quot;, province, region), wealth = ifelse(is.na(wealth_index_factor_score_5_decimals), wealth_index_factor_score_combined_5_decimals, wealth_index_factor_score_5_decimals), rapid_test0 = ifelse(is.na(result_of_rapid_test_of_malaria), result_of_malaria_rapid_test_2, result_of_rapid_test_of_malaria), rapid_test0 = ifelse(is.na(rapid_test0), result_of_malaria_rapid_test, rapid_test0), # rapid_test0 = ifelse(result_of_rapid_test_of_malaria==&quot;&quot;, result_of_malaria_rapid_test_2, # result_of_rapid_test_of_malaria), # rapid_test0 = ifelse(rapid_test0==&quot;&quot;, result_of_malaria_rapid_test, # rapid_test0), rapid_test = ifelse(str_detect(rapid_test0, &quot;positive&quot;), 1, 0), rapid_test = ifelse(rapid_test0==&quot;&quot;, NA, rapid_test), education = recode(mothers_highest_educational_level, &quot;9&quot; = &quot;0_dontknow&quot;, &quot;don&#39;t know&quot; = &quot;0_dontknow&quot;, &quot;no education&quot; = &quot;1_noeducation&quot;, &quot;no education / pre-primary&quot; = &quot;1_noeducation&quot;, &quot;elementary (1-6)&quot; = &quot;2_elementary/primary&quot;, &quot;primary&quot; = &quot;2_elementary/primary&quot;, &quot;junior high (7-9)&quot; = &quot;3_junorsenhigh/secondary&quot;, &quot;secondary&quot; = &quot;3_junorsenhigh/secondary&quot;, &quot;senior high (10-12)&quot; = &quot;3_junorsenhigh/secondary&quot;, &quot;higher&quot; = &quot;4_higher&quot;), edu = as.numeric(as.factor(education)), edu = ifelse(edu==1,NA,edu-1)) gps_export &lt;- dat_gps_flat %&gt;% ungroup() %&gt;% mutate(cluster_number = as.character(DHSCLUST)) %&gt;% dplyr::select(country, DHSID, DHSYEAR, cluster_number, URBAN_RURA, LATNUM, LONGNUM, ALT_DEM, DATUM) %&gt;% arrange(-DHSYEAR) %&gt;% distinct(country, cluster_number, .keep_all = T) write.csv(gps_export, &quot;./_dat/dat_gps_flat.csv&quot;, na=&quot;&quot;, row.names = F) dat_export &lt;- dhs_export %&gt;% inner_join(gps_export, by = c(&quot;country&quot;, &quot;cluster_number&quot;)) %&gt;% mutate(REGNAME = toupper(REGNAME), REGNAME = str_replace_all(REGNAME, pattern = &quot;-&quot;, replacement = &quot; &quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;REGION&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;PROVINCE&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;AREA&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;NORTHEASTERN&quot;, replacement = &quot;NORTH EASTERN&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;NORTHERN&quot;, replacement = &quot;NORTH&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;SOUTHERN&quot;, replacement = &quot;SOUTH&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;GREATER&quot;, replacement = &quot;&quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot; DE &quot;, replacement = &quot; DU &quot;), REGNAME = str_replace_all(REGNAME, pattern = &quot;KARUZI&quot;, replacement = &quot;KARUSI&quot;), REGNAME = str_trim(REGNAME, side = &quot;both&quot;)) write.csv(dat_export, &quot;./_dat/dat_mal_ineq_v2.csv&quot;, na=&quot;&quot;, row.names = F) # # epiDisplay::tab1(dat_s_flat$result_of_rapid_test_of_malaria) # epiDisplay::tab1(dat_s_flat$result_of_rapid_test_of_malaria) # epiDisplay::tab1(dhs_export$result_of_rapid_test_of_malaria) # epiDisplay::tab1(dhs_export$rapid_test0) # epiDisplay::tab1(dhs_export$rapid_test) "],
["analysis-wealth.html", "Chapter 3 Analysis Wealth 3.1 Processing - Wealth 3.2 Spatial data - Wealth 3.3 Distributions - Wealth 3.4 CI - Wealth 3.5 SII - Wealth 3.6 RII - Wealth 3.7 Summary - Wealth", " Chapter 3 Analysis Wealth 3.1 Processing - Wealth rm(list = ls()) library(IC2) library(codebook) library(tidyverse) dat &lt;- read.csv(&quot;./_dat/dat_mal_ineq_v2.csv&quot;) source(&quot;./mal_ineq_fun.R&quot;) # epiDisplay::tab1(dat$rapid_test) #codebook_browser(dat) # ==== NOT RUN ======= # ao &lt;- dat %&gt;% # filter(country == &quot;SN&quot;) %&gt;% # dplyr::select(rapid_test, wealth, w) %&gt;% # filter(complete.cases(.)) # # ao_ci &lt;- IC2::calcSConc(x = ao$rapid_test, # y = ao$wealth, # w = ao$w) # ==== NOT RUN ======= dat.n &lt;- dat %&gt;% group_by(country, REGNAME, cluster_number) %&gt;% nest() %&gt;% mutate(sample.size.N = map(.x = data, .f = ~dplyr::select(.x, rapid_test, wealth, w) %&gt;% count(name = &quot;N&quot;)), sample.size.m = map(.x = data, .f = ~dplyr::select(.x, rapid_test, wealth, w) %&gt;% filter(!is.na(rapid_test)) %&gt;% count(name = &quot;N_m&quot;)), dat_s = map(.x = data, .f = ~dplyr::select(.x, rapid_test, wealth, w) %&gt;% filter(complete.cases(.))), sample.size = map(.x = dat_s, .f = ~count(.x)), prev = map(.x = dat_s, .f = ~mean(.x$rapid_test, na.rm=T)), wealth_cats = map(.x = dat_s, .f = ~distinct(.x, wealth) %&gt;% nrow())) %&gt;% # FILTERS ======================= filter(prev &gt; 0 &amp; prev &lt; 1) %&gt;% filter(wealth_cats&gt;1) dat_ci.n &lt;- dat.n %&gt;% mutate(ci = map(.x = dat_s, .f = ~IC2::calcSConc(x = .x$rapid_test, y = .x$wealth, w = .x$w)), ci_val = map(.x = ci, .f = ~.x$ineq$index), h_calc = map(.x = dat_s, .f = ~h_ineq(dat = .x, var_soc = wealth, var_outcome = rapid_test)) ) dat_ci &lt;- dat_ci.n %&gt;% dplyr::select(country, cluster_number, sample.size.N, sample.size.m, sample.size, prev, wealth_cats, ci_val, h_calc) %&gt;% unnest() %&gt;% ungroup() # Checks ======== dat_ci %&gt;% ggplot(aes(x=c_index, y = ci_val)) + geom_point(alpha = .4) + labs(x = &quot;hand calculation&quot;, y = &quot;package calculation&quot;) # ==== NOT RUN ======= # unique(dat.n$country) # unique(dat_ci$country) # # range(dat$w) # range(dat_ci$N_m) # range(dat_ci$n) # range(dat_ci$ci_val, na.rm = T) # # hist(dat_ci$N_m) # hist(dat_ci$n) # hist(dat_ci$ci_val) # ==== NOT RUN ======= 3.2 Spatial data - Wealth ## Reading layer `DHS_adm&#39; from data source `/research-home/gcarrasco/mal_ineq/_dat/SHP/union/DHS_adm.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 147 features and 3 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -13.30198 ymin: -26.86819 xmax: 50.49459 ymax: 15.7047 ## CRS: 4326 3.3 Distributions - Wealth library(cowplot) a &lt;- hist_ineq(dat_ci, n, &quot;Sample Size&quot;) b &lt;- hist_ineq(dat_ci, prev, &quot;Prevalence&quot;) c &lt;- bi_hist_ineq(dat_ci, var_x = prev, var_y = n, lab_x = &quot;Prevalence&quot;, lab_y = &quot;Sample Size&quot;) (dist &lt;- plot_grid(a,b,c, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), nrow = 1)) 3.4 CI - Wealth 3.4.1 Plots CI - Wealth library(cowplot) ci_box_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = ci_val) ci_box_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = ci_val) ci_box_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = ci_val) (ci_box1 &lt;- plot_grid(ci_box_10, ci_box_20, ci_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) ci_prev_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = ci_val) ci_prev_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = ci_val) ci_prev_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = ci_val) (ci_prev1 &lt;- plot_grid(ci_prev_10, ci_prev_20, ci_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 3.4.2 Maps CI - Wealth library(mapview) m1 &lt;- dat_ci_map %&gt;% filter(!is.na(ci_val)) %&gt;% mapview(zcol = &quot;ci_val&quot;, legend = TRUE, layer.name = &quot;Concentration Index &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_ci_adm %&gt;% mapview(zcol = &quot;ci_val&quot;, legend = TRUE, layer.name = &quot;Concentration Index &lt;/br&gt;(Adm)&quot;) m1 + m2 3.5 SII - Wealth 3.5.1 Plots SII - Wealth library(cowplot) sii_box_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) sii_box_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) sii_box_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) (sii_box &lt;- plot_grid(sii_box_10, sii_box_20, sii_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) sii_prev_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) sii_prev_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) sii_prev_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) (sii_prev &lt;- plot_grid(sii_prev_10, sii_prev_20, sii_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 3.5.2 Maps SII - Wealth library(mapview) m1 &lt;- dat_ci_map %&gt;% filter(!is.na(sii)) %&gt;% mapview(zcol = &quot;sii&quot;, legend = TRUE, layer.name = &quot;Slope Index of Inequality &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_ci_adm %&gt;% mapview(zcol = &quot;sii&quot;, legend = TRUE, layer.name = &quot;Slope Index of Inequality &lt;/br&gt;(Adm)&quot;) m1 + m2 3.6 RII - Wealth 3.6.1 Plots RII - Wealth library(cowplot) rii_box_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_box_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_box_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) (rii_box &lt;- plot_grid(rii_box_10, rii_box_20, rii_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) rii_prev_10 &lt;- dat_ci %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_prev_20 &lt;- dat_ci %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_prev_30 &lt;- dat_ci %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) (rii_prev &lt;- plot_grid(rii_prev_10, rii_prev_20, rii_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 3.6.2 Maps RII - Wealth library(mapview) m1 &lt;- dat_ci_map %&gt;% filter(!is.na(rii)) %&gt;% filter(quantile(rii, .1, na.rm = T)&lt;=rii) %&gt;% filter(quantile(rii, .9, nna.rm = T)&gt;=rii) %&gt;% mapview(zcol = &quot;rii&quot;, legend = TRUE, layer.name = &quot;Relative Index of Inequality &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_ci_adm %&gt;% filter(quantile(rii, .1, na.rm = T)&lt;=rii) %&gt;% filter(quantile(rii, .9, nna.rm = T)&gt;=rii) %&gt;% mapview(zcol = &quot;rii&quot;, legend = TRUE, layer.name = &quot;Relative Index of Inequality &lt;/br&gt;(Adm)&quot;) m1 + m2 3.7 Summary - Wealth library(cowplot) a &lt;- bi_hist_ineq(dat_ci, var_x = ci_val, var_y = rii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Relative Index of Inequality&quot;) a2 &lt;- bi_hist_ineq(dat_ci, var_x = ci_val, var_y = rii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Relative Index of Inequality (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) b &lt;- bi_hist_ineq(dat_ci, var_x = sii, var_y = rii, lab_x = &quot;Slope Index of Inequality&quot;, lab_y = &quot;Relative Index of Inequality (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) c &lt;- bi_hist_ineq(dat_ci, var_x = ci_val, var_y = sii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Slope Index of Inequality&quot;) (indexes &lt;- plot_grid(a,a2,b,c, labels = c(&quot;A)&quot;, &quot;A2)&quot;, &quot;B)&quot;,&quot;C)&quot;), nrow = 2)) "],
["analysis-education.html", "Chapter 4 Analysis Education 4.1 Processing - Education 4.2 Spatial data - Education 4.3 CI - Education 4.4 SII - Education 4.5 RII - Education 4.6 Summary -Education", " Chapter 4 Analysis Education 4.1 Processing - Education rm(list = ls()) library(IC2) library(codebook) library(tidyverse) dat &lt;- read.csv(&quot;./_dat/dat_mal_ineq_v2.csv&quot;) source(&quot;./mal_ineq_fun.R&quot;) # epiDisplay::tab1(dat$rapid_test) # epiDisplay::tab1(dat$mothers_highest_educational_level) # epiDisplay::tab1(dat$education) # epiDisplay::tab1(dat$edu) #codebook_browser(dat) # ==== NOT RUN ======= # ao &lt;- dat %&gt;% # filter(country == &quot;SN&quot;) %&gt;% # dplyr::select(rapid_test, edu, w) %&gt;% # filter(complete.cases(.)) # # ao_ci &lt;- IC2::calcSConc(x = ao$rapid_test, # y = ao$edu, # w = ao$w) # ==== NOT RUN ======= dat.n &lt;- dat %&gt;% group_by(country, REGNAME, cluster_number) %&gt;% nest() %&gt;% mutate(sample.size.N = map(.x = data, .f = ~dplyr::select(.x, rapid_test, edu, w) %&gt;% count(name = &quot;N&quot;)), sample.size.m = map(.x = data, .f = ~dplyr::select(.x, rapid_test, edu, w) %&gt;% filter(!is.na(rapid_test)) %&gt;% count(name = &quot;N_m&quot;)), dat_s = map(.x = data, .f = ~dplyr::select(.x, rapid_test, edu, w) %&gt;% filter(complete.cases(.))), sample.size = map(.x = dat_s, .f = ~count(.x)), prev = map(.x = dat_s, .f = ~mean(.x$rapid_test, na.rm=T)), edu_cats = map(.x = dat_s, .f = ~distinct(.x, edu) %&gt;% nrow())) %&gt;% # FILTERS ======================= filter(prev &gt; 0 &amp; prev &lt; 1) %&gt;% filter(edu_cats&gt;1) dat_edu.n &lt;- dat.n %&gt;% mutate(ci = map(.x = dat_s, .f = ~IC2::calcSConc(x = .x$rapid_test, y = .x$edu, w = .x$w)), ci_val = map(.x = ci, .f = ~.x$ineq$index), h_calc = map(.x = dat_s, .f = ~h_ineq(dat = .x, var_soc = edu, var_outcome = rapid_test)) ) dat_edu &lt;- dat_edu.n %&gt;% dplyr::select(country, cluster_number, sample.size.N, sample.size.m, sample.size, prev, edu_cats, ci_val, h_calc) %&gt;% unnest() %&gt;% ungroup() # Checks ======== dat_edu %&gt;% ggplot(aes(x=c_index, y = ci_val)) + geom_point(alpha = .4) + labs(x = &quot;hand calculation&quot;, y = &quot;package calculation&quot;) # ==== NOT RUN ======= # unique(dat.n$country) # unique(dat_ci$country) # # range(dat$w) # range(dat_ci$N_m) # range(dat_ci$n) # range(dat_ci$ci_val, na.rm = T) # # hist(dat_ci$N_m) # hist(dat_ci$n) # hist(dat_ci$ci_val) # ==== NOT RUN ======= 4.2 Spatial data - Education library(sf) library(leaflet) library(stringr) dat_edu_map &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% inner_join(read.csv(&quot;./_dat/dat_gps_flat.csv&quot;), by = c(&quot;country&quot;, &quot;cluster_number&quot;)) %&gt;% st_as_sf(coords = c(&quot;LONGNUM&quot;, &quot;LATNUM&quot;), crs = 4326) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) #saveRDS(dat_edu_map, &quot;./_dat/dat_edu_map_v2.rds&quot;) dat_adm &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% group_by(country, REGNAME) %&gt;% summarise(N = sum(N, na.rm = T), N_m = sum(N_m, na.rm = T), n = sum(n, na.rm = T), prev = median(prev, na.rm = T), ci_val = median(ci_val, na.rm = T), sii = median(sii, na.rm = T), rii = median(rii, na.rm = T)) dat_edu_adm &lt;- st_read(&quot;./_dat/SHP/union/DHS_adm.shp&quot;) %&gt;% inner_join(dat_adm, by = c(&quot;country&quot;, &quot;REGNAME&quot;)) ## Reading layer `DHS_adm&#39; from data source `/research-home/gcarrasco/mal_ineq/_dat/SHP/union/DHS_adm.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 147 features and 3 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -13.30198 ymin: -26.86819 xmax: 50.49459 ymax: 15.7047 ## CRS: 4326 # NOT RUN / checks for REGNAME ======= # dat_edu_adm %&gt;% # st_set_geometry(NULL) %&gt;% # write.csv(&quot;./_dat/dat_ci_adm.csv&quot;, na=&quot;&quot;) # NOT RUN / checks for REGNAME ======= 4.3 CI - Education 4.3.1 Plots CI -Education library(cowplot) ci_box_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = ci_val) ci_box_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = ci_val) ci_box_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = ci_val) (ci_box1 &lt;- plot_grid(ci_box_10, ci_box_20, ci_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) ci_prev_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = ci_val) ci_prev_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = ci_val) ci_prev_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = ci_val) (ci_prev1 &lt;- plot_grid(ci_prev_10, ci_prev_20, ci_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 4.3.2 Maps CI - Education library(mapview) m1 &lt;- dat_edu_map %&gt;% filter(!is.na(ci_val)) %&gt;% mapview(zcol = &quot;ci_val&quot;, legend = TRUE, layer.name = &quot;Concentration Index &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_edu_adm %&gt;% mapview(zcol = &quot;ci_val&quot;, legend = TRUE, layer.name = &quot;Concentration Index &lt;/br&gt;(Adm)&quot;) m1 + m2 4.4 SII - Education 4.4.1 Plots SII - Education library(cowplot) sii_box_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) sii_box_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) sii_box_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = sii, y_lab = &quot;SII&quot;) (sii_box &lt;- plot_grid(sii_box_10, sii_box_20, sii_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) sii_prev_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) sii_prev_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) sii_prev_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = sii, y_lab = &quot;SII&quot;) (sii_prev &lt;- plot_grid(sii_prev_10, sii_prev_20, sii_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 4.4.2 Maps SII - Education library(mapview) m1 &lt;- dat_edu_map %&gt;% filter(!is.na(sii)) %&gt;% mapview(zcol = &quot;sii&quot;, legend = TRUE, layer.name = &quot;Slope Index of Inequality &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_edu_adm %&gt;% mapview(zcol = &quot;sii&quot;, legend = TRUE, layer.name = &quot;Slope Index of Inequality &lt;/br&gt;(Adm)&quot;) m1 + m2 4.5 RII - Education 4.5.1 Plots RII - Education library(cowplot) rii_box_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_box_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_box_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_box(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) (rii_box &lt;- plot_grid(rii_box_10, rii_box_20, rii_box_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) rii_prev_10 &lt;- dat_edu %&gt;% filter(n&gt;=10) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_prev_20 &lt;- dat_edu %&gt;% filter(n&gt;=20) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) rii_prev_30 &lt;- dat_edu %&gt;% filter(n&gt;=30) %&gt;% ci_prev(var = rii, y_lab = &quot;RII (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) (rii_prev &lt;- plot_grid(rii_prev_10, rii_prev_20, rii_prev_30, labels = c(&quot;A)&quot;, &quot;B)&quot;, &quot;C)&quot;), ncol = 1)) 4.5.2 Maps RII - Education library(mapview) m1 &lt;- dat_edu_map %&gt;% filter(!is.na(rii)) %&gt;% filter(quantile(rii, .1, na.rm = T)&lt;=rii) %&gt;% filter(quantile(rii, .9, nna.rm = T)&gt;=rii) %&gt;% mapview(zcol = &quot;rii&quot;, legend = TRUE, layer.name = &quot;Relative Index of Inequality &lt;/br&gt;(psu)&quot;) m2 &lt;- dat_edu_adm %&gt;% filter(quantile(rii, .1, na.rm = T)&lt;=rii) %&gt;% filter(quantile(rii, .9, nna.rm = T)&gt;=rii) %&gt;% mapview(zcol = &quot;rii&quot;, legend = TRUE, layer.name = &quot;Relative Index of Inequality &lt;/br&gt;(Adm)&quot;) m1 + m2 4.6 Summary -Education library(cowplot) a &lt;- bi_hist_ineq(dat_edu, var_x = ci_val, var_y = rii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Relative Index of Inequality&quot;) a2 &lt;- bi_hist_ineq(dat_edu, var_x = ci_val, var_y = rii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Relative Index of Inequality (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) b &lt;- bi_hist_ineq(dat_edu, var_x = sii, var_y = rii, lab_x = &quot;Slope Index of Inequality&quot;, lab_y = &quot;Relative Index of Inequality (p10th-90th)&quot;, trim.y.l = 0.1, trim.y.u = 0.9) c &lt;- bi_hist_ineq(dat_edu, var_x = ci_val, var_y = sii, lab_x = &quot;Concentration Index&quot;, lab_y = &quot;Slope Index of Inequality&quot;) (indexes &lt;- plot_grid(a,a2,b,c, labels = c(&quot;A)&quot;, &quot;A2)&quot;, &quot;B)&quot;,&quot;C)&quot;), nrow = 2)) "],
["spatial-analysis.html", "Chapter 5 Spatial Analysis 5.1 Processing 5.2 Wealth 5.3 Education", " Chapter 5 Spatial Analysis 5.1 Processing rm(list = ls()) library(tidyverse) library(spdep) library(tmap) library(sf) library(leaflet) dat_ci_map &lt;- readRDS(&quot;./_dat/dat_ci_map_v2.rds&quot;) dat_edu_map &lt;- readRDS(&quot;./_dat/dat_edu_map_v2.rds&quot;) %&gt;% filter(!is.infinite(rii)) source(&quot;./mal_ineq_fun.R&quot;) breaks &lt;- c(-Inf, -2.58, -1.96, -1.65, 1.65, 1.96, 2.58, Inf) labels &lt;- c(&quot;Cold spot: 99% confidence&quot;, &quot;Cold spot: 95% confidence&quot;, &quot;Cold spot: 90% confidence&quot;, &quot;PSU Not significant&quot;,&quot;Hot spot: 90% confidence&quot;, &quot;Hot spot: 95% confidence&quot;, &quot;Hot spot: 99% confidence&quot;) 5.2 Wealth dat_ci_sp &lt;- as(dat_ci_map, &quot;Spatial&quot;) coords&lt;-coordinates(dat_ci_sp) IDs&lt;-row.names(as.data.frame(coords)) Neigh_nb&lt;-knn2nb(knearneigh(coords, k=1, longlat = TRUE), row.names=IDs) dsts&lt;-unlist(nbdists(Neigh_nb,coords)) max_1nn&lt;-max(dsts) Neigh_kd1&lt;-dnearneigh(coords,d1=0, d2=max_1nn, row.names=IDs) self&lt;-nb2listw(Neigh_kd1, style=&quot;W&quot;, zero.policy = T) w.getis &lt;- dat_ci_map %&gt;% st_set_geometry(NULL) %&gt;% nest() %&gt;% crossing(var1 = c(&quot;ci_val&quot;, &quot;sii&quot;, &quot;rii&quot;)) %&gt;% mutate(data_sub = map2(.x = data, .y = var1, .f = ~dplyr::select(.x, .y, country, cluster_number, prev, lat, long) %&gt;% rename(output = 1)), LISA = map(.x = data_sub, .f = ~localG(.x$output, self)), clust_LISA = map(.x = LISA, .f = ~cut(.x, include.lowest = TRUE, breaks = breaks, labels = labels))) %&gt;% dplyr::select(data_sub, var1, LISA, clust_LISA) %&gt;% unnest() 5.2.1 W-CI dat_w_map_ci &lt;- w.getis %&gt;% filter(var1 ==&quot;ci_val&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_w_map_ci$clust_LISA, reverse = T) dat_w_map_ci %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_w_map_ci$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_w_map_ci$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_w_map_ci$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_w_map_ci$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_w_map_ci$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Wealth CI&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) 5.2.2 W-SII dat_w_map_sii &lt;- w.getis %&gt;% filter(var1 ==&quot;sii&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_w_map_sii$clust_LISA, reverse = T) dat_w_map_sii %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_w_map_sii$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_w_map_sii$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_w_map_sii$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_w_map_sii$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_w_map_sii$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Wealth SII&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) 5.2.3 W-RII dat_w_map_rii &lt;- w.getis %&gt;% filter(var1 ==&quot;rii&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_w_map_rii$clust_LISA, reverse = T) dat_w_map_rii %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_w_map_rii$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_w_map_rii$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_w_map_rii$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_w_map_rii$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_w_map_rii$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Wealth RII&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) 5.3 Education dat_edu_sp &lt;- as(dat_edu_map, &quot;Spatial&quot;) coords&lt;-coordinates(dat_edu_sp) IDs&lt;-row.names(as.data.frame(coords)) Neigh_nb&lt;-knn2nb(knearneigh(coords, k=1, longlat = TRUE), row.names=IDs) dsts&lt;-unlist(nbdists(Neigh_nb,coords)) max_1nn&lt;-max(dsts) Neigh_kd1&lt;-dnearneigh(coords,d1=0, d2=max_1nn, row.names=IDs) self&lt;-nb2listw(Neigh_kd1, style=&quot;W&quot;, zero.policy = T) w.getis_e &lt;- dat_edu_map %&gt;% st_set_geometry(NULL) %&gt;% nest() %&gt;% crossing(var1 = c(&quot;ci_val&quot;, &quot;sii&quot;, &quot;rii&quot;)) %&gt;% mutate(data_sub = map2(.x = data, .y = var1, .f = ~dplyr::select(.x, .y, country, cluster_number, prev, lat, long) %&gt;% rename(output = 1)), LISA = map(.x = data_sub, .f = ~localG(.x$output, self)), clust_LISA = map(.x = LISA, .f = ~cut(.x, include.lowest = TRUE, breaks = breaks, labels = labels))) %&gt;% dplyr::select(data_sub, var1, LISA, clust_LISA) %&gt;% unnest() 5.3.1 E-CI dat_e_map_ci &lt;- w.getis_e %&gt;% filter(var1 ==&quot;ci_val&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_e_map_ci$clust_LISA, reverse = T) dat_e_map_ci %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_e_map_ci$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_e_map_ci$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_e_map_ci$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_e_map_ci$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_e_map_ci$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Education CI&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) 5.3.2 E-SII dat_e_map_sii &lt;- w.getis_e %&gt;% filter(var1 ==&quot;sii&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_e_map_sii$clust_LISA, reverse = T) dat_e_map_sii %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_e_map_sii$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_e_map_sii$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_e_map_sii$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_e_map_sii$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_e_map_sii$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Education SII&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) 5.3.3 E-RII dat_e_map_rii &lt;- w.getis_e %&gt;% filter(var1 ==&quot;rii&quot;) %&gt;% st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326) %&gt;% filter(!is.na(LISA)) %&gt;% dplyr::mutate(lat = sf::st_coordinates(.)[,2], long = sf::st_coordinates(.)[,1]) pal &lt;- colorFactor(&quot;RdBu&quot;, dat_e_map_rii$clust_LISA, reverse = T) dat_e_map_rii %&gt;% leaflet() %&gt;% addTiles() %&gt;% addCircles(lng = ~long, lat = ~lat, color = ~ pal(clust_LISA), popup = paste(&quot;Country&quot;, dat_e_map_rii$country, &quot;&lt;br&gt;&quot;, &quot;Cluster:&quot;, dat_e_map_rii$cluster_number, &quot;&lt;br&gt;&quot;, &quot;Malaria Prevalence:&quot;, dat_e_map_rii$prev, &quot;&lt;br&gt;&quot;, &quot;CI:&quot;, dat_e_map_rii$output, &quot;&lt;br&gt;&quot;, &quot;LISA:&quot;, dat_e_map_rii$LISA)) %&gt;% addLegend(&quot;bottomright&quot;, pal = pal, values = ~clust_LISA, title = &quot;LISA - Education RII&quot;) %&gt;% addScaleBar(position = c(&quot;bottomleft&quot;)) "]
]
